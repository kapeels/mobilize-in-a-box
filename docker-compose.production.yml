version: '2'
services:
  nginx:
    restart: unless-stopped
    environment:
      - FORCE_SSL=true
      - VIRTUAL_HOST=http://${MIAB_URL},https://${MIAB_URL}
      - EXCLUDE_PORTS=443
      - EXTRA_SETTINGS=acl fix_rstudio res.hdr(Location) -m sub rstudio:8787, rspirep ^Location:\ https://rstudio:8787/(.*)      Location:\ https://${MIAB_URL}/navbar/rstudio/\1 if fix_rstudio, acl fix_https res.hdr(Location) -m sub http://, rspirep ^Location:\ http://(.*)      Location:\ https://\1 if fix_https
    networks:
      - inside
      - outside
 
  ohmage:
    restart: unless-stopped
    networks:
      - inside
    environment:
      - MYSQL_PASSWORD=abetterpassword
 
  db:
    restart: unless-stopped
    networks:
      - inside
    environment:
      - MYSQL_PASSWORD=abetterpassword
      - MYSQL_ROOT_PASSWORD=abetterrootpassword
 
  ocpu:
    restart: unless-stopped
    networks:
      - inside
  
  rstudio:
    restart: unless-stopped
    networks:
      - inside
    environment:
      - MYSQL_PASSWORD=abetterpassword
  
  pw:
    restart: unless-stopped
    networks:
      - inside

  # this configuration is not particularly "production" as mail will likely end up in spam!
  mail:
    image: alezzandro/postfix
    restart: unless-stopped
    environment:
      - myhostname=${MIAB_URL}
    networks:
      - inside

networks:
  outside:
    external:
      name: lb_outside
  inside:
    driver: bridge